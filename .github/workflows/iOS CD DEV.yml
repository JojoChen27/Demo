name: iOS CD DEV

on:
  pull_request:
    types: [closed]
    branches: dev*

jobs:
  dev-deploy:
    if: github.event.pull_request.merged == true
    runs-on: macOS-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Print
        run: |
          echo "开始执行输出"
          echo "开始执行输出1111"
          echo "开始执行输出1111"
          exit 1
      - name: Notify Slack on Success
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_MOBILE_WEBHOOK }}
          SLACK_MESSAGE_TITLE: "✅ CoinEx iOS 打包完成，已上传到服务器"
        run: |
          # 获取PR信息
          pr_url="${{ github.event.pull_request.html_url }}"
          pr_number="${{ github.event.pull_request.number }}"
          pr_title="${{ github.event.pull_request.title }}"

          # 获取Body
          pr_body="${{ github.event.pull_request.body }}"
          escaped_pr_body="${pr_body//$'\n'/\\n}"
          if [ -z "$escaped_pr_body" ]; then
            escaped_pr_body="未填写⭕"
          fi
          escaped_pr_body="*Description:*\n$escaped_pr_body"

          # 获取提交信息
          commits=$(git log --pretty=format:"%H - %s (%an)" "${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}")
          # 提取每个提交的哈希和消息，并构建链接
          formatted_commits=""
          while read -r line; do
            commit_hash=$(echo "$line" | awk '{print $1}')
            commit_message=$(echo "$line" | awk '{$1=""; print $0}')
            commit_url="$pr_url/commits/$commit_hash"
            formatted_commit="<$commit_url|${commit_message}>"
            formatted_commits="${formatted_commits}${formatted_commit}\n"
          done <<< "$commits"
          formatted_commits="*Commits:*\n$formatted_commits"

          curl -X POST -H 'Content-type: application/json' --data @- $SLACK_WEBHOOK <<CURL_DATA
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "$SLACK_MESSAGE_TITLE",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "点击按钮进行下载"
                },
                "accessory": {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "下载",
                    "emoji": true
                  },
                  "url": "http://3.33.146.9:5000/",
                  "style": "primary"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<$pr_url|#$pr_number $pr_title>"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "$escaped_pr_body"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "$formatted_commits"
                }
              }
            ]
          }
          CURL_DATA
      - name: Notify Slack on Failure
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_MOBILE_WEBHOOK }}
          SLACK_MESSAGE_TITLE: "❌ CoinEx iOS 打包失败，请查看运行错误"
        run: |
          curl -X POST -H 'Content-type: application/json' --data @- $SLACK_WEBHOOK <<CURL_DATA
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "$SLACK_MESSAGE_TITLE",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "点击按钮查看运行错误"
                },
                "accessory": {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "查看",
                    "emoji": true
                  },
                  "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "style": "danger"
                }
              }
            ]
          }
          CURL_DATA
